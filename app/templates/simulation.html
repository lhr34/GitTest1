{% extends "base.html" %}

{% block content %}
<h1>Power Management Simulation</h1>

<div class="alert alert-secondary d-flex justify-content-between align-items-center">
  <div><strong>Last Update：</strong> {{ latest_reading['timestamp'] if latest_reading != "N/A" else "No data available" }}</div>
  <div><strong>Auto Refresh In：</strong> <span id="countdown">05:00</span></div>
</div>

<div class="d-flex gap-2 mb-3">
  <form method="post" action="{{ url_for('simulation') }}">
    <button type="submit" class="btn btn-success">
      <i class="bi bi-lightning-charge"></i> Simulate New Reading
    </button>
  </form>
  <form method="post" action="{{ url_for('reset_simulation') }}">
    <button type="submit" class="btn btn-warning">
      <i class="bi bi-arrow-counterclockwise"></i> Reset Data History
    </button>
  </form>
</div>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h3 class="mb-0">Power Control Mode</h3>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('simulation') }}" class="row g-3">
      <div class="col-md-12">
        <div class="d-flex justify-content-between flex-wrap">
          <!-- Control Systems -->
          <div class="mb-2">
            <h5>Control Modes</h5>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="control_mode" id="autoMode" value="auto"
                     {% if control_mode == 'auto' %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="autoMode">
                Auto Control
              </label>
            </div>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="control_mode" id="ecoMode" value="eco"
                     {% if control_mode == 'eco' %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="ecoMode">
                Eco Mode
              </label>
            </div>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="control_mode" id="normalMode" value="normal"
                     {% if control_mode == 'normal' %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="normalMode">
                Normal Mode
              </label>
            </div>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="control_mode" id="full-powerMode" value="full-power"
                     {% if control_mode == 'full-power' %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="full-powerMode">
                  FULL-POWER Mode
              </label>
            </div>
          </div>

          <!--Integrate simple control systems using adaptor-->
          <div>
            <h5>Integrated Control Modes</h5>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="control_mode" id="simpleMode" value="simple"
                     {% if control_mode == 'simple' %}checked{% endif %} onchange="this.form.submit()">
              <label class="form-check-label" for="simpleMode">
                 Simple Auto Control
              </label>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="mt-3">
      <h5>Current Mode:
        <span class="badge {% if control_mode == 'auto' %}bg-secondary{% elif control_mode == 'eco' %}bg-success{% elif control_mode == 'normal' %}bg-primary{% elif control_mode == 'simple' %}bg-warning{% elif control_mode == 'external' %}bg-info{% else %}bg-danger{% endif %}">
          {{ control_mode|upper }}
        </span>
      </h5>
    </div>
  </div>
</div>


<div class="card mb-4">
  <div class="card-header">
    <h3>Latest Sensor Reading</h3>
  </div>
  <div class="card-body">
    {% if latest_reading != "N/A" %}
      <div class="row">
        <div class="col-md-6">
          <p><strong>Timestamp:</strong> {{ latest_reading['timestamp'] }}</p>
          <p><strong>Temperature:</strong> {{ "%.1f"|format(latest_reading['TemperatureSensor']) }} °C</p>
        </div>
        <div class="col-md-6">
          <p><strong>Humidity:</strong> {{ latest_reading['HumiditySensor'] }}%</p>
          <p><strong>Light:</strong> {{ latest_reading['LightSensor'] }} lux</p>
          <p><strong>Power Consumption:</strong> {{ latest_reading['power_consumption'] }} Watts</p>
        </div>
      </div>
    {% else %}
      <p class="text-muted">No data available</p>
    {% endif %}
  </div>
</div>

<div class="alert {% if control_mode == 'auto' %}alert-info{% elif control_mode == 'eco' %}alert-success{% elif control_mode == 'normal' %}alert-primary{% elif control_mode == 'simple' %}alert-warning{% elif control_mode == 'external' %}alert-info{% else %}alert-danger{% endif %} mb-4">
  <h4 class="alert-heading">Control Action</h4>
  <p>{{ control_action }}</p>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h3>Power Consumption History</h3>
  </div>
  <div class="card-body">
    <canvas id="powerChart" height="200"></canvas>
    {% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('powerChart').getContext('2d');
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: {{ timestamps|tojson }},
            datasets: [{
              label: 'Power Consumption (Watts)',
              data: {{ power_history|tojson }},
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderWidth: 2,
              tension: 0.1,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: 'Watts'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Time'
                }
              }
            }
          }
        });


        let secondsLeft = 300;
        function updateCountdown() {
          const minutes = Math.floor(secondsLeft / 60);
          const seconds = secondsLeft % 60;
          document.getElementById("countdown").textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

          if (secondsLeft > 0) {
            secondsLeft--;
          } else {
            location.reload();
          }
        }
        setInterval(updateCountdown, 1000);
        updateCountdown();
      });
    </script>
    {% endblock %}
  </div>
</div>


<div class="card mb-4">
  <div class="card-header">
    <h3>Analysis Report</h3>
  </div>
  <div class="card-body">
    <p>{{ report }}</p>
    {% if alerts %}
      <div class="alert alert-danger">
        <strong>Alerts:</strong>
        <ul>
          {% for alert in alerts %}
            <li>{{ "%.1f"|format(alert) }} Watts (exceeds threshold)</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <p class="text-success">No alerts detected.</p>
    {% endif %}
  </div>
</div>

{% endblock %}